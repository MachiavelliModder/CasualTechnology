
clock = script.Activity.Value
isotopeactivity = 1

local function reflect(vector, normal)
	return -2 * vector:Dot(normal) * normal + vector;
end 


local function drawray(ray, parent)
	local part = Instance.new("Part");
	part.Material = Enum.Material.Neon;
	part.Size = Vector3.new(.2, .2, ray.Direction.magnitude);
	part.CFrame = CFrame.new(ray.Origin + ray.Direction/2, ray.Origin + ray.Direction);
	part.Anchored = true;
	part.CanCollide = false;
	part.BrickColor = BrickColor.new("Bright red");
	part.Parent = parent or game.Workspace.CurrentCamera;
	return part;
end

function spreadradiation(part,hitpos)
	local m = coroutine.create(function()
		local c = script:Clone()
		local p = Instance.new("Attachment",script.Parent)
		p.WorldPosition = hitpos
		c.Parent = p
		c.IsotopeActivity.Max.Value = script.IsotopeActivity.Max.Value / 2
		c.Activity.Value = 0
		while wait(1) do
			c.Activity.Value = c.Activity.Value + 0.001
			if c.Activity.Value > 7 then
				p:Destroy()
			end
		end
	end)
	coroutine.resume(m)
end

function fireisotope(from,to,b,t)
	local m122 = coroutine.create(function()
		wait(Random.new():NextNumber(0,.2))
		--	warn("fired")
		local bounce
		if b == nil then
			bounce = 0
		else
			bounce = b
		end
		if bounce <= 10 then
			local ray = Ray.new(from, (to - from).unit * 10000);

			if t == "g" then
				local ray = Ray.new(from, (to - from).unit * 100000);
			elseif t == "b" then
				local ray = Ray.new(from, (to - from).unit * 100);
			elseif t == "a" then
				local ray = Ray.new(from, (to - from).unit * 10);
			end

			local hit, pos, normal = game:GetService("Workspace"):FindPartOnRay(ray, script.Parent);

			--	local ray2 = Ray.new(from, (pos - from));

			local ref = reflect((pos - from), normal);
			--	local part = drawray(ray2, script.Parent);

			--	game:GetService("Debris"):AddItem(part, 2);

			if hit then
				if game:GetService("Players"):GetPlayerFromCharacter(hit.Parent) then
					game:GetService("ReplicatedStorage").RADHIT:FireClient(game:GetService("Players"):GetPlayerFromCharacter(hit.Parent),t,isotopeactivity,hit)
				end

				if hit.Material == Enum.Material.Concrete then
					fireisotope(pos, pos + ref, nil,t)
				else
					if game:GetService("Players"):GetPlayerFromCharacter(hit.Parent) then
					else
						if hit:FindFirstChild("Radiation") then
						else
							--	spreadradiation(hit,pos)
						end
					end
					fireisotope(pos, pos + ref, nil,t)
				end
			end	
		end
	end)
	coroutine.resume(m122)
end

while wait(clock) do
	if script.Type.Value == "g" then
		pos = nil
		if script.Parent:IsA("Attachment") then
			pos = script.Parent.WorldPosition
		else
			pos = script.Parent.Position
		end
		fireisotope(pos,Vector3.new(Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180)),nil,"g")
	elseif script.Type.Value == "b" then
		pos = nil
		if script.Parent:IsA("Attachment") then
			pos = script.Parent.WorldPosition
		else
			pos = script.Parent.Position
		end
		fireisotope(pos,Vector3.new(Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180)),nil,"b")
	elseif script.Type.Value == "a" then
		pos = nil
		if script.Parent:IsA("Attachment") then
			pos = script.Parent.WorldPosition
		else
			pos = script.Parent.Position
		end
		fireisotope(pos,Vector3.new(Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180),Random.new():NextNumber(-180,180)),nil,"a")
	end

	if script.Activity.Value == 0 then
		clock = game:GetService("RunService").Heartbeat:Wait()
	else
		clock = script.Activity.Value
	end

	isotopeactivity = Random.new():NextNumber(script.IsotopeActivity.Min.Value,script.IsotopeActivity.Max.Value)
end
